"use strict";var t=require("react"),e=require("react-draggable");function i(){return(i=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(t[a]=i[a])}return t}).apply(this,arguments)}function a(t,e){return void 0===e&&(e=""),new Promise((function(i,a){var r,h=new Image;h.onload=function(){return i(h)},h.onerror=a,0==(null!==(r=t)&&!!r.match(/^\s*data:([a-z]+\/[a-z]+(;[a-z-]+=[a-z-]+)?)?(;base64)?,[a-z0-9!$&',()*+;=\-._~:@/?%\s]*\s*$/i))&&e&&(h.crossOrigin=e),h.src=t}))}var r=function(t){return t*(Math.PI/180)},h="undefined"!=typeof File,s="undefined"!=typeof window&&window.devicePixelRatio?window.devicePixelRatio:1,n={x:.5,y:.5,width:0,height:0},o=function(o){var g,c;function d(e){var a;return(a=o.call(this,e)||this).pixelRatio=s,a.clearImage=function(){var t=a.getCanvas();a.getContext().clearRect(0,0,t.width,t.height),a.setState({image:n})},a.handleDrag=function(t,e){var h=e.deltaX,s=e.deltaY,n=a.props,o=n.rotate,g=n.scale,c=n.onPositionChange,d=a.state.image,p=o%360<0?o+360:o%360,l=d.width*g,u=d.height*g,m=a.getCroppingRect(),v=m.x,w=m.y,f=Math.cos(r(p)),y=Math.sin(r(p)),x=w*u+h*y+-s*f,I={x:(v*l+-h*f+s*y)/l+1/g*a.getXScale()/2,y:x/u+1/g*a.getYScale()/2};c&&c(I),a.setState({image:i({},a.state.image,{},I)})},a.handleStartDrag=function(){return a.setState({dragging:!0})},a.handleStopDrag=function(){return a.setState({dragging:!1})},a.state={dragging:!1,image:n},a.canvas=t.createRef(),a.pixelRatio=e.disableHiDPIScaling?1:s,a}c=o,(g=d).prototype=Object.create(c.prototype),g.prototype.constructor=g,g.__proto__=c;var p=d.prototype;return p.componentDidMount=function(){this.loadImage();var t=this.getContext();this.paint(t)},p.componentDidUpdate=function(t,e){this.props.image&&this.props.image!==t.image||this.props.width!==t.width||this.props.height!==t.height?this.loadImage():this.props.image||this.clearImage();var i=this.getCanvas(),a=this.getContext();a.clearRect(0,0,i.width,i.height),this.paint(a),this.paintImage(a,this.state.image,this.props.border),t.image===this.props.image&&t.width===this.props.width&&t.height===this.props.height&&t.position===this.props.position&&t.scale===this.props.scale&&t.rotate===this.props.rotate&&e.image.x===this.state.image.x&&e.image.y===this.state.image.y||this.props.onImageChange&&this.props.onImageChange()},p.getCanvas=function(){if(!this.canvas.current)throw new Error("No canvas found, please report this to: https://github.com/mosch/react-avatar-editor/issues");return this.canvas.current},p.getContext=function(){var t=this.getCanvas().getContext("2d");if(!t)throw new Error(" No context found, please report this to: https://github.com/mosch/react-avatar-editor/issues");return t},p.isVertical=function(){return this.props.rotate%180!=0},p.getBorders=function(t){return Array.isArray(t)?t:[t,t]},p.getDimensions=function(){var t=this.props,e=t.width,i=t.height,a=t.rotate,r=t.border,h=this.getBorders(r),s=h[0],n=h[1];return{canvas:this.isVertical()?{width:i+2*s,height:e+2*n}:{width:e+2*s,height:i+2*n},rotate:a,width:e,height:i,border:r}},p.getImage=function(){var t=this.getCroppingRect(),e=this.state.image,a=document.createElement("canvas");if(e.resource){var r=i({},t,{x:t.x*e.resource.width,y:t.y*e.resource.height,width:t.width*e.resource.width,height:t.height*e.resource.height});this.isVertical()?(a.width=r.height,a.height=r.width):(a.width=r.width,a.height=r.height);var h=a.getContext("2d");h&&(h.translate(a.width/2,a.height/2),h.rotate(this.props.rotate*Math.PI/180),h.translate(-a.width/2,-a.height/2),this.isVertical()&&h.translate((a.width-a.height)/2,(a.height-a.width)/2),h.drawImage(e.resource,-t.x,-t.y))}return a},p.getImageScaledToCanvas=function(){var t=this.getDimensions(),e=t.width,i=t.height,a=document.createElement("canvas");this.isVertical()?(a.width=i,a.height=e):(a.width=e,a.height=i);var r=a.getContext("2d");return r&&this.paintImage(r,this.state.image,0,1),a},p.getXScale=function(){return Math.min(1,this.props.width/this.props.height/(this.state.image.width/this.state.image.height))},p.getYScale=function(){return Math.min(1,this.props.height/this.props.width/(this.state.image.height/this.state.image.width))},p.getCroppingRect=function(){var t=this.props.position||{x:this.state.image.x,y:this.state.image.y},e=1/this.props.scale*this.getXScale(),a=1/this.props.scale*this.getYScale(),r={x:t.x-e/2,y:t.y-a/2,width:e,height:a},h=0,s=1-r.width,n=0,o=1-r.height;return(this.props.disableBoundaryChecks||e>1||a>1)&&(h=-r.width,s=1,n=-r.height,o=1),i({},r,{x:Math.max(h,Math.min(r.x,s)),y:Math.max(n,Math.min(r.y,o))})},p.loadImage=function(){var t,e=this,r=this.props,s=r.image,n=r.onLoadFailure,o=r.onImageReady,g=r.onLoadSuccess,c=r.crossOrigin,d=function(t){var a=i({},e.getInitialSize(t.width,t.height),{resource:t,x:.5,y:.5});e.setState({image:a},o),g&&g(a)};h&&s instanceof File?(t=s,new Promise((function(e,i){var r=new FileReader;r.onload=function(t){try{if(t.target){var r=a(t.target.result);e(r)}else i("No target")}catch(t){i(t)}},r.readAsDataURL(t)}))).then(d).catch(n):"string"==typeof s&&a(s,c).then(d).catch(n)},p.getInitialSize=function(t,e){var i=this.getDimensions();return i.height/i.width>e/t?{height:i.height,width:t*(i.height/e)}:{width:i.width,height:e*(i.width/t)}},p.paintImage=function(t,e,i,a){if(void 0===a&&(a=s),e.resource){var r=this.calculatePosition(e,i),h=this.getCroppingRect(),n=h.x,o=h.y;t.fillStyle="red",t.fillRect(n,o,3,3),t.save(),t.translate(t.canvas.width/2,t.canvas.height/2),t.rotate(this.props.rotate*Math.PI/180),t.translate(-t.canvas.width/2,-t.canvas.height/2),this.isVertical()&&t.translate((t.canvas.width-t.canvas.height)/2,(t.canvas.height-t.canvas.width)/2),t.scale(a,a),t.globalCompositeOperation="destination-over",t.drawImage(e.resource,r.x,r.y,r.width,r.height),t.restore()}},p.calculatePosition=function(t,e){var i=this.getBorders(e),a=i[0],r=i[1],h=this.getCroppingRect(),s=t.width*this.props.scale,n=t.height*this.props.scale,o=-h.x*s,g=-h.y*n;return this.isVertical()?(o+=r,g+=a):(o+=a,g+=r),{x:o,y:g,height:n,width:s}},p.paint=function(t){t.save(),t.scale(this.pixelRatio,this.pixelRatio),t.translate(0,0),t.fillStyle="rgba("+this.props.color.slice(0,4).join(",")+")";var e=this.props.borderRadius,i=this.getDimensions(),a=this.getBorders(i.border),r=a[0],h=a[1],s=i.canvas.height,n=i.canvas.width;e=Math.max(e,0),e=Math.min(e,n/2-r,s/2-h),t.beginPath(),function(t,e,i,a,r,h){if(0===h)t.rect(e,i,a,r);else{var s=a-h,n=r-h;t.translate(e,i),t.arc(h,h,h,Math.PI,1.5*Math.PI),t.lineTo(s,0),t.arc(s,h,h,1.5*Math.PI,2*Math.PI),t.lineTo(a,n),t.arc(s,n,h,2*Math.PI,.5*Math.PI),t.lineTo(h,r),t.arc(h,n,h,.5*Math.PI,Math.PI),t.translate(-e,-i)}}(t,r,h,n-2*r,s-2*h,e),t.rect(n,0,-n,s),t.fill("evenodd"),t.restore()},p.render=function(){var a=this.props,r=a.style,h=function(t,e){if(null==t)return{};var i,a,r={},h=Object.keys(t);for(a=0;a<h.length;a++)e.indexOf(i=h[a])>=0||(r[i]=t[i]);return r}(a,["scale","rotate","image","border","borderRadius","width","height","position","color","style","crossOrigin","onLoadFailure","onLoadSuccess","onImageReady","onImageChange","onMouseUp","onMouseMove","onPositionChange","disableBoundaryChecks","disableHiDPIScaling"]),s=this.getDimensions(),n={width:s.canvas.width*this.pixelRatio,height:s.canvas.height*this.pixelRatio,style:i({},{width:s.canvas.width,height:s.canvas.height,cursor:this.state.dragging?"grabbing":"grab",touchAction:"none"},{},r)};return t.createElement(e.DraggableCore,{onStart:this.handleStartDrag,onStop:this.handleStopDrag,onDrag:this.handleDrag},t.createElement("canvas",Object.assign({ref:this.canvas},n,h)))},d}(t.Component);o.defaultProps={scale:1,rotate:0,border:25,borderRadius:0,width:200,height:200,color:[0,0,0,.5],disableBoundaryChecks:!1,disableHiDPIScaling:!1},exports.default=o;
//# sourceMappingURL=react-avatar-editor.cjs.production.min.js.map
